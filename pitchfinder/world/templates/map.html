{% extends 'base.html' %}

{% block title %}
Pitchfinder - Map
{% endblock title %}

{% block content %}
<div id="map" style="height: 400px;"></div>
<button onclick="updateLocation()">Update Location</button>

<script>
    // Check if location values are set; default to a location if not
    var initialLat = {{ location.y|default:53.45 }};  // Default to North Dublin lat
    var initialLng = {{ location.x|default:-6.15 }};  // Default to North Dublin lng

    console.log('Initial Latitude:', initialLat, 'Initial Longitude:', initialLng);

    // Create the map and set initial view to the user's location, or use default coordinates
    var map = L.map('map').setView([initialLat, initialLng], 9);

    // Add tile layer to the map (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // *** Custom Icon Definitions ***
    // Red Icon for Hardcoded Markers
    var redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],          // size of the icon
        iconAnchor: [12, 41],        // point of the icon which will correspond to marker's location
        popupAnchor: [1, -34],       // point from which the popup should open relative to the iconAnchor
        shadowSize: [41, 41]          // size of the shadow
    });

    // Blue Icon for Dynamic User Location Marker
    var blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    // *** End of Custom Icon Definitions ***

    // Add a dynamic marker if there's a location (initially redIcon, can be updated to blueIcon)
    {% if location %}
        userMarker = L.marker([{{ location.y }}, {{ location.x }}], { icon: blueIcon })  // Using blueIcon initially
            .addTo(map)
            .bindPopup('<b>{{ user.username }}</b><br />')
            .openPopup();
    {% endif %}

    // *** Hardcoded Markers Section ***
    // Define an array of hardcoded markers with latitude, longitude, and popup content
    var pitchMarkers = [
        {
            lat: 53.3385, 
            lng: -6.2654, 
            popup: "<b>Digges Street</b><br />Football pitch"
        },
        {
            lat: 53.3776, 
            lng: -6.2517, 
            popup: "<b>Whitehall Stadium</b><br />Football pitch"
        },
        {
            lat: 53.3249, 
            lng: -6.2346, 
            popup: "<b>Herbert Park</b><br />Football pitch"
        },
        {
            lat: 53.3191, 
            lng: -6.2297, 
            popup: "<b>Donnybrook</b><br />Rugby pitch"
        },
        {
            lat: 53.3728, 
            lng: -6.2043, 
            popup: "<b>St. Vincent's GAA Club</b><br />GAA pitch"
        },
        {
            lat: 53.5224, 
            lng: -6.0939, 
            popup: "<b>St. Maur's GAA Club</b><br />GAA pitch"
        },
        // Add more hardcoded markers as needed
    ];


    // Iterate over the hardcoded markers array and add each marker to the map with the red icon
    pitchMarkers.forEach(function(marker) {
        L.marker([marker.lat, marker.lng], { icon: redIcon }).addTo(map)
            .bindPopup(marker.popup);
    });
    // *** End of Hardcoded Markers Section ***

    // Variables for the dynamic marker and accuracy circle
    var userMarker;
    var circle;

    // Function to update the map with new marker and accuracy circle
    function updateMap(latitude, longitude, accuracy) {
        if (userMarker) {
            map.removeLayer(userMarker);  // Remove the old marker
        }
        if (circle) {
            map.removeLayer(circle);  // Remove the old circle
        }

        // Add the new marker and circle with the blue icon
        userMarker = L.marker([latitude, longitude], { icon: blueIcon })  // Using blueIcon for user location
            .addTo(map)
            .bindPopup('Your Location')
            .openPopup();

        circle = L.circle([latitude, longitude], { radius: accuracy }).addTo(map);

        // Recenter the map view
        map.setView([latitude, longitude], 9);
    }

    // Function to get the user's current geolocation and update the map
    function updateLocation() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;
                var accuracy = position.coords.accuracy;

                // Update the map
                updateMap(latitude, longitude, accuracy);

                // Send location data to Django view via a POST request
                fetch('{% url "update_location" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
                    },
                    body: 'latitude=' + latitude + '&longitude=' + longitude
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Location updated successfully');
                    } else {
                        console.error('Error updating location');
                    }
                });
            },
            function(error) {
                console.error('Error getting location:', error);
            }
        );
    }
</script>
{% endblock content %}
